# Selfsteal - Caddy/Nginx for Reality

> 🌐 **Проект [gig.ovh](https://gig.ovh)** | Автор: **[DigneZzZ](https://github.com/DigneZzZ)**

Скрипт для автоматической установки и управления веб-сервером (Caddy или Nginx) для маскировки трафика Reality в связке с Xray. Порт 443 остается свободным для Xray.

![изображение](https://github.com/user-attachments/assets/fb82bb59-c6f5-48f4-a6a8-25540be6c03e)


## Основные возможности

- **Выбор веб-сервера**: Caddy (по умолчанию) или Nginx с флагом `--nginx`
- **Unix Socket (Nginx)**: По умолчанию Nginx использует Unix socket для лучшей производительности
- **ACME SSL сертификаты**: Let's Encrypt через TLS-ALPN на порту 8443 (не требует 80 порт)
- **Автоустановка Docker**: Автоматическая установка Docker если не установлен
- **Проверка Firewall**: Автопроверка UFW, firewalld, iptables
- **Защита от перезаписи**: Проверка пользовательских файлов и создание бэкапов
- **Валидация DNS**: Проверка правильности настройки домена
- **11 AI-шаблонов**: Профессиональные шаблоны для реалистичной маскировки
- **Управление сервисами**: Запуск, остановка, перезапуск, логи, статус
- **Автообновление**: Проверка и установка обновлений скрипта

## Архитектура

### Caddy (TCP порт)
```
┌─────────────────────────────────────────────────────────────┐
│                         Интернет                            │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼ :443
┌─────────────────────────────────────────────────────────────┐
│                     Xray (Reality)                          │
│                   Занимает порт 443                         │
│         Принимает VLESS подключения с Reality               │
└──────────────────────────┬──────────────────────────────────┘
                           │ proxy_protocol
                           ▼ 127.0.0.1:9443
┌─────────────────────────────────────────────────────────────┐
│                        Caddy                                │
│         Слушает ТОЛЬКО на 127.0.0.1:9443                    │
│      Отдаёт сайт-обманку через proxy_protocol               │
└─────────────────────────────────────────────────────────────┘
```

### Nginx (Unix Socket - по умолчанию)
```
┌─────────────────────────────────────────────────────────────┐
│                         Интернет                            │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼ :443
┌─────────────────────────────────────────────────────────────┐
│                     Xray (Reality)                          │
│                   Занимает порт 443                         │
│         Принимает VLESS подключения с Reality               │
└──────────────────────────┬──────────────────────────────────┘
                           │ proxy_protocol (xver: 1)
                           ▼ /dev/shm/nginx.sock
┌─────────────────────────────────────────────────────────────┐
│                        Nginx                                │
│       Слушает на Unix Socket /dev/shm/nginx.sock            │
│      Отдаёт сайт-обманку через proxy_protocol               │
└─────────────────────────────────────────────────────────────┘
```

**Важно**: Веб-сервер (Caddy/Nginx) **НЕ слушает на порту 443**. Порт 443 полностью принадлежит Xray. Веб-сервер получает трафик от Xray через внутренний порт или Unix socket с proxy_protocol.

## Требования

- **Операционная система**: Linux (Ubuntu, Debian, CentOS и другие).
- **Права root**: Скрипт должен выполняться с sudo.
- **Зависимости**: Docker и curl (устанавливаются автоматически).
- **Дисковое пространство**: Минимум 1 ГБ свободного места.
- **Домен**: Настроенный домен, указывающий на IP сервера.
- **Порты**:
  - **443** — зарезервирован для **Xray** (не занимается веб-сервером!)
  - **Unix socket** `/dev/shm/nginx.sock` — для Nginx (по умолчанию)
  - **9443** — внутренний TCP порт веб-сервера (Caddy или Nginx с `--tcp`)
  - **80** — редирект на HTTPS (Caddy) или ACME HTTP challenge
  - **8443** — ACME TLS-ALPN для Nginx (с автофолбэком на другие порты)

## Установка

### Быстрая установка

**Caddy (по умолчанию):**
```bash
bash <(curl -Ls https://github.com/DigneZzZ/remnawave-scripts/raw/main/selfsteal.sh) @ install
```

**Nginx с Unix Socket (рекомендуется):**
```bash
bash <(curl -Ls https://github.com/DigneZzZ/remnawave-scripts/raw/main/selfsteal.sh) @ --nginx install
```

**Nginx с TCP портом:**
```bash
bash <(curl -Ls https://github.com/DigneZzZ/remnawave-scripts/raw/main/selfsteal.sh) @ --nginx --tcp install
```

**Nginx с кастомным портом ACME:**
```bash
bash <(curl -Ls https://github.com/DigneZzZ/remnawave-scripts/raw/main/selfsteal.sh) @ --nginx --acme-port 15443 install
```

### Ручная установка

```bash
sudo bash -c "curl -fsSL https://raw.githubusercontent.com/DigneZzZ/remnawave-scripts/main/selfsteal.sh -o /usr/local/bin/selfsteal && chmod +x /usr/local/bin/selfsteal"
```

Затем:
```bash
selfsteal install              # Caddy (TCP порт)
selfsteal --nginx install      # Nginx (Unix Socket, рекомендуется)
selfsteal --nginx --tcp install  # Nginx (TCP порт)
```

## Использование

```bash
selfsteal              # Интерактивное меню
selfsteal help         # Справка
```

### Основные команды

| Команда | Описание |
|---------|----------|
| `install` | Установить веб-сервер |
| `up` / `down` | Запустить / Остановить сервисы |
| `restart` | Перезапустить сервисы |
| `status` | Показать статус и информацию о SSL |
| `logs` | Просмотреть логи |
| `template` | Управление шаблонами сайта |
| `edit` | Редактировать конфигурацию |
| `renew-ssl` | Обновить SSL сертификат (только Nginx) |
| `uninstall` | Удалить установку |
| `update` | Обновить скрипт |

### Опции веб-сервера

```bash
selfsteal --caddy install       # Caddy (по умолчанию)
selfsteal --nginx install       # Nginx с Unix Socket (по умолчанию)
selfsteal --nginx --tcp install # Nginx с TCP портом
```

### Опции Nginx

| Опция | Описание |
|-------|----------|
| `--socket` | Использовать Unix Socket (по умолчанию) |
| `--tcp` | Использовать TCP порт вместо socket |
| `--acme-port <port>` | Кастомный порт для ACME TLS-ALPN |

При установке Nginx для получения SSL-сертификата используется ACME TLS-ALPN challenge. По умолчанию скрипт пробует порты в следующем порядке: **8443 → 9443 → 10443 → 18443 → 28443**.

Если все порты заняты или нужен конкретный порт:
```bash
selfsteal --nginx --acme-port 12345 install
```

> ⚠️ Порт ACME нужен только временно во время получения/обновления сертификата.

## Сравнение Caddy vs Nginx

| Функция | Caddy | Nginx |
|---------|-------|-------|
| SSL сертификаты | Автоматически (внутренние) | ACME (Let's Encrypt) с автофолбэком портов |
| Конфигурация | Caddyfile | nginx.conf + conf.d/ |
| Путь установки | `/opt/caddy` | `/opt/nginx-selfsteal` |
| **Режим подключения** | TCP порт (127.0.0.1:9443) | **Unix Socket** (по умолчанию) или TCP |
| **Xray target** | `127.0.0.1:9443` | `/dev/shm/nginx.sock` (socket) или `127.0.0.1:9443` (tcp) |
| Обновление SSL | Автоматически | `selfsteal renew-ssl` |
| Порт для ACME | 80 (ACME HTTP) | 8443+ (ACME TLS-ALPN) или `--acme-port` |

### Преимущества Unix Socket (Nginx)
- **Быстрее**: Нет накладных расходов на TCP стек
- **Безопаснее**: Не занимает сетевой порт
- **Проще**: Нет конфликтов портов

## Шаблоны сайтов

Команда `template` позволяет выбрать один из 11 AI-генерированных шаблонов, созданных нейросетью специально для реалистичной маскировки трафика:

### 🎨 Доступные шаблоны:

1. **😂 10gag - Сайт мемов**: Платформа для просмотра мемов с имитацией видеоконтента
2. **🎬 Converter - Видеостудия-конвертер**: Онлайн сервис для конвертации видео с поддержкой популярных платформ
3. **📁 Convertit - Конвертер файлов**: Универсальный конвертер с проверкой форматов и симуляцией обработки
4. **⬇️ Downloader - Даунлоадер**: Сервис загрузок с системой приглашений и проверками
5. **☁️ FileCloud - Облачное хранилище**: Файлохранилище с красивой формой авторизации и файловым менеджером
6. **🎮 Games-site - Ретро игровой портал**: Сайт с классическими браузерными играми и сгенерированными ИИ обложками
7. **🛠️ ModManager - Мод-менеджер для игр**: Имитация сайта для управления модификациями игр
8. **🚀 SpeedTest - Спидтест**: Тестирование скорости интернет-соединения с русской локализацией
9. **📺 YouTube - Видеохостинг с капчей**: Платформа для видео с бесконечной капчей и плиточным интерфейсом
10. **⚠️ 503 Error v1 - Страница ошибки 503**: Стильная страница ошибки с отображением IP-адреса клиента
11. **⚠️ 503 Error v2 - Страница ошибки 503**: Альтернативный дизайн страницы ошибки

### 🤖 Особенности AI-шаблонов:

- **Полностью созданы нейросетью**: Все HTML, CSS, JavaScript и дизайн
- **Реалистичная имитация**: Шаблоны имитируют настоящие популярные сервисы
- **Автоматическое скачивание**: Загружаются напрямую из GitHub репозитория
- **Случайная установка**: При первой установке автоматически выбирается случайный шаблон
- **Адаптивный дизайн**: Работают на всех устройствах
- **Интерактивные элементы**: Функциональные кнопки и формы для реалистичности

### 🔄 Дополнительные опции:

- **View Current Template**: Просмотреть информацию о текущем установленном шаблоне
- **Keep Current Template**: Сохранить текущий шаблон без изменений

После выбора шаблона можно перезапустить Caddy для применения изменений. Все шаблоны автоматически создают резервную копию предыдущего контента.

### 📦 Источник шаблонов

Все шаблоны загружаются из репозитория [sni-templates](https://github.com/SmallPoppa/sni-templates), где содержится полная коллекция AI-генерированных веб-шаблонов с подробными описаниями и превью каждого шаблона.

## Конфигурация Xray Reality

После установки веб-сервера настройте Xray Reality, используя параметры из установки.

### Nginx с Unix Socket (рекомендуется)

```json
{
    "inbounds": [
        {
            "tag": "VLESS_REALITY_NGINX_SOCKET",
            "port": 443,
            "protocol": "vless",
            "settings": {
                "clients": [],
                "decryption": "none"
            },
            "sniffing": {
                "enabled": true,
                "destOverride": ["http", "tls", "quic"]
            },
            "streamSettings": {
                "network": "raw",
                "security": "reality",
                "realitySettings": {
                    "show": false,
                    "xver": 1,
                    "target": "/dev/shm/nginx.sock",
                    "spiderX": "/",
                    "shortIds": [""],
                    "privateKey": "#REPLACE_WITH_YOUR_PRIVATE_KEY",
                    "serverNames": ["reality.example.com"]
                }
            }
        }
    ]
}
```

### Caddy или Nginx с TCP портом

```json
{
    "inbounds": [
        {
            "tag": "VLESS_REALITY_TCP",
            "port": 443,
            "protocol": "vless",
            "settings": {
                "clients": [],
                "decryption": "none"
            },
            "sniffing": {
                "enabled": true,
                "destOverride": ["http", "tls", "quic"]
            },
            "streamSettings": {
                "network": "raw",
                "security": "reality",
                "realitySettings": {
                    "show": false,
                    "xver": 1,
                    "target": "127.0.0.1:9443",
                    "spiderX": "/",
                    "shortIds": [""],
                    "privateKey": "#REPLACE_WITH_YOUR_PRIVATE_KEY",
                    "serverNames": ["reality.example.com"]
                }
            }
        }
    ]
}
```

### Параметры для замены

| Параметр | Описание |
|----------|----------|
| `target` | `/dev/shm/nginx.sock` (Nginx socket) или `127.0.0.1:9443` (TCP) |
| `xver` | Всегда `1` для proxy_protocol v1 |
| `serverNames` | Ваш домен, указанный при установке |
| `privateKey` | Ваш сгенерированный приватный ключ Reality |
| `shortIds` | Ваши Reality short IDs |

> ⚠️ При добавлении селфстила не забудьте при создании хоста указать принудительно SNI и Host таким же, как у вас указано в `serverNames`.

<img width="438" height="435" alt="изображение" src="https://github.com/user-attachments/assets/57f00a62-1cad-4225-825c-23ed6a779744" />

## Кастомизация

- **AI-шаблоны**: Используйте команду `template` для выбора из 11 профессиональных AI-генерированных шаблонов
- **HTML-контент**: Редактируйте файлы в директории установки (`/opt/caddy/html` или `/opt/nginx-selfsteal/html`)
- **Конфигурация**: Используйте команду `edit` для изменения настроек
- **Логи**: Доступны через команду `logs`
- **Автоматические бэкапы**: При смене шаблона автоматически создается резервная копия предыдущего контента

## Управление логами
Скрипт включает продвинутую систему управления логами:

- **Просмотр размера логов** - показывает текущий размер файлов логов
- **Ограничение логов** - устанавливает максимальный размер (по умолчанию 50MB)
- **Очистка логов** - безопасное удаление старых записей
- **Ротация логов** - автоматическое архивирование при достижении лимита

## 🔧 Конфигурация

### Основные файлы
После установки создается следующая структура:

```
./
├── docker-compose.yml    # Docker Compose конфигурация
├── Caddyfile            # Конфигурация Caddy
├── .env                 # Переменные окружения
└── html/                # Статические файлы сайта
    ├── index.html
    ├── css/
    ├── js/
    └── assets/
```

### Переменные окружения (.env)
```bash
DOMAIN=your-domain.com          # Ваш домен
REALITY_DEST=8080              # Порт Reality назначения
REALITY_SERVER_NAMES=          # Дополнительные серверные имена
```

## 🔄 Обновления

### Автоматическое обновление
Скрипт поддерживает автоматическое обновление до последней версии:
1. Запустите скрипт
2. Выберите пункт "9) Обновить скрипт"
3. Скрипт автоматически скачает и установит последнюю версию


### Общие проблемы и решения

#### Проблема: Контейнер не запускается
**Решение**: Проверьте логи и убедитесь, что порты не заняты
```bash
docker logs caddy_reality_container
netstat -tlnp | grep :80
netstat -tlnp | grep :443
```

#### Проблема: SSL сертификат не получается
**Решение**: Убедитесь, что домен корректно настроен и доступен
```bash
# Проверка DNS
nslookup your-domain.com
dig your-domain.com A

# Проверка доступности порта
telnet your-domain.com 80
telnet your-domain.com 443
```

#### Проблема: Сайт не отображается
**Решение**: Проверьте файлы шаблона и права доступа
```bash
ls -la html/
docker exec caddy_reality_container ls -la /var/www/html/
```

## 🗑 Удаление

Для полного удаления установки:
```bash
selfsteal uninstall
```

При переустановке скрипт проверяет наличие пользовательских файлов и предлагает создать бэкап.

> ⚠️ Можно установить только **один** веб-сервер (Caddy или Nginx). Для смены сервера сначала удалите текущий.

## 🔐 Безопасность

### Рекомендации по безопасности
- Используйте только доверенные домены
- Регулярно обновляйте скрипт и Docker образы
- Мониторьте логи на предмет подозрительной активности
- Ограничьте доступ к серверу файрволом

### Файлы с чувствительными данными
- `.env` - содержит конфигурацию домена
- `Caddyfile` - содержит настройки TLS
- Логи - могут содержать IP адреса и запросы

## 📚 Дополнительные ресурсы

- [Документация Caddy](https://caddyserver.com/docs/)
- [Docker Compose документация](https://docs.docker.com/compose/)
- [Reality Protocol](https://github.com/XTLS/Reality)
- [SNI Templates - AI-генерированные шаблоны](https://github.com/DigneZzZ/remnawave-scripts/tree/main/sni-templates)

## Лицензия

MIT License. Подробности в файле [LICENSE](LICENSE).

## Контакты

- **Проект**: [gig.ovh](https://gig.ovh)
- **Автор**: [DigneZzZ](https://github.com/DigneZzZ)
- **Репозиторий**: [github.com/DigneZzZ/remnawave-scripts](https://github.com/DigneZzZ/remnawave-scripts)
- **Issues**: Открывайте issue на GitHub для вопросов и предложений.


## 🤝 Поддержка

Если у вас возникли вопросы или проблемы:
1. Проверьте раздел "Диагностика" выше
2. Посмотрите логи контейнера: `docker logs caddy_reality_container`
3. Создайте Issue в [GitHub репозитории](https://github.com/DigneZzZ/remnawave-scripts/issues)
